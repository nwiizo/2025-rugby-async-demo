//! Rust 2024 Edition: ãƒ©ã‚°ãƒ“ãƒ¼éåŒæœŸæˆ¦è¡“ãƒ‡ãƒ¢
//!
//! ã“ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ã€éåŒæœŸãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®æ¦‚å¿µã‚’
//! ãƒ©ã‚°ãƒ“ãƒ¼ã®ã‚¹ã‚¿ãƒ³ãƒ‰ã‚ªãƒ•ã®åˆ¤æ–­ãƒ—ãƒ­ã‚»ã‚¹ã«ä¾‹ãˆã¦èª¬æ˜ã—ã¾ã™ã€‚
//!
//! # Rust 2024 Editionã®æ–°æ©Ÿèƒ½
//!
//! - **Preludeæ”¹å–„**: `Future`ã¨`IntoFuture`ãŒè‡ªå‹•ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
//! - **RPIT**: Return Position Impl Traitã§ã‚ˆã‚Šç°¡æ½”ãªå‹ã‚·ã‚°ãƒãƒãƒ£
//! - **Comprehensive docs**: ã™ã¹ã¦ã®å…¬é–‹APIã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
use tokio::time::{Duration, sleep};

// =============================================================================
// å‹å®šç¾©
// =============================================================================

/// ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹ãƒ©ã‚¤ãƒ³ã®çŠ¶æ…‹
///
/// ãƒ©ã‚°ãƒ“ãƒ¼ã®ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹ãƒ©ã‚¤ãƒ³ã®é…ç½®ã‚’è¡¨ç¾ã—ã¾ã™ã€‚
#[derive(Debug, Clone)]
struct DefenseLine {
    /// ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹ã‹ã‚‰ã®ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ãŒã‚ã‚‹ã‹
    pressure: bool,
    /// å·¦ã‚µã‚¤ãƒ‰ã«ã‚®ãƒ£ãƒƒãƒ—ãŒã‚ã‚‹ã‹
    gap_on_left: bool,
    /// å³ã‚µã‚¤ãƒ‰ã«ã‚®ãƒ£ãƒƒãƒ—ãŒã‚ã‚‹ã‹ï¼ˆå°†æ¥çš„ãªæ‹¡å¼µç”¨ï¼‰
    #[allow(dead_code)]
    gap_on_right: bool,
}

/// ãƒãƒ¼ãƒ ãƒ¡ã‚¤ãƒˆã®æº–å‚™çŠ¶æ…‹
///
/// ãƒãƒƒã‚¯ã‚¹ã¨ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ãã‚Œãã‚Œã®æº–å‚™çŠ¶æ³ã‚’ç®¡ç†ã—ã¾ã™ã€‚
#[derive(Debug, Clone)]
struct Teammates {
    /// ãƒãƒƒã‚¯ã‚¹ã®æº–å‚™ãŒã§ãã¦ã„ã‚‹ã‹
    backs_ready: bool,
    /// ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã®æº–å‚™ãŒã§ãã¦ã„ã‚‹ã‹
    forwards_ready: bool,
}

// =============================================================================
// éåŒæœŸé–¢æ•°
// =============================================================================

/// ã‚¹ã‚¯ãƒ©ãƒ ãƒãƒ¼ãƒ•ã‹ã‚‰ã®ãƒ‘ã‚¹ã‚’å¾…æ©Ÿ
///
/// # Returns
///
/// ãƒœãƒ¼ãƒ«å—é ˜å®Œäº†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
async fn wait_for_ball() -> String {
    println!("ğŸ‰ ã‚¹ã‚¯ãƒ©ãƒ ãƒãƒ¼ãƒ•ã‹ã‚‰ã®ãƒ‘ã‚¹ã‚’å¾…æ©Ÿ...");
    sleep(Duration::from_secs(2)).await;
    println!("âœ“ ãƒœãƒ¼ãƒ«å—ã‘å–ã‚Šå®Œäº†");
    "ãƒœãƒ¼ãƒ«å—é ˜".to_string()
}

/// ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹ãƒ©ã‚¤ãƒ³ã‚’åˆ†æ
///
/// ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹ã®é…ç½®ã€ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã®æœ‰ç„¡ã€ã‚®ãƒ£ãƒƒãƒ—ã®ä½ç½®ã‚’ç¢ºèªã—ã¾ã™ã€‚
///
/// # Returns
///
/// åˆ†æã•ã‚ŒãŸãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹ãƒ©ã‚¤ãƒ³ã®çŠ¶æ…‹
async fn read_defense() -> DefenseLine {
    println!("ğŸ‘€ ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹ãƒ©ã‚¤ãƒ³ã‚’èª­ã‚€...");
    sleep(Duration::from_secs(1)).await;

    let defense = DefenseLine {
        pressure: false,
        gap_on_left: true,
        gap_on_right: false,
    };

    println!("âœ“ ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹åˆ†æå®Œäº†: å·¦ã«ã‚®ãƒ£ãƒƒãƒ—ã‚ã‚Š");
    defense
}

/// ãƒãƒ¼ãƒ ãƒ¡ã‚¤ãƒˆã®ãƒã‚¸ã‚·ãƒ§ãƒ‹ãƒ³ã‚°ã‚’ç¢ºèª
///
/// ãƒãƒƒã‚¯ã‚¹ã¨ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ãã‚Œãã‚Œã®æº–å‚™çŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚
///
/// # Returns
///
/// ãƒãƒ¼ãƒ ãƒ¡ã‚¤ãƒˆã®æº–å‚™çŠ¶æ…‹
async fn check_teammates() -> Teammates {
    println!("ğŸ‘¥ å‘³æ–¹ã®ãƒã‚¸ã‚·ãƒ§ãƒ‹ãƒ³ã‚°ç¢ºèª...");
    sleep(Duration::from_millis(800)).await;

    let teammates = Teammates {
        backs_ready: true,
        forwards_ready: true,
    };

    println!("âœ“ å‘³æ–¹ã®æº–å‚™å®Œäº†");
    teammates
}

/// ãƒãƒƒã‚¯ã‚¹ã«å±•é–‹ã®ã‚µã‚¤ãƒ³ã‚’é€ã‚‹
///
/// éåŒæœŸã§ãƒãƒƒã‚¯ã‚¹ã«æŒ‡ç¤ºã‚’å‡ºã—ã€æº–å‚™å®Œäº†ã‚’å¾…ã¡ã¾ã™ã€‚
async fn signal_backs() {
    println!("ğŸ“¢ ãƒãƒƒã‚¯ã‚¹ã«å±•é–‹ã®ã‚µã‚¤ãƒ³...");
    sleep(Duration::from_millis(500)).await;
    println!("âœ“ ãƒãƒƒã‚¯ã‚¹æº–å‚™å®Œäº†");
}

/// ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã«ã‚µãƒãƒ¼ãƒˆã®ã‚µã‚¤ãƒ³ã‚’é€ã‚‹
///
/// éåŒæœŸã§ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã«æŒ‡ç¤ºã‚’å‡ºã—ã€æº–å‚™å®Œäº†ã‚’å¾…ã¡ã¾ã™ã€‚
async fn signal_forwards() {
    println!("ğŸ“¢ ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã«ã‚µãƒãƒ¼ãƒˆã®ã‚µã‚¤ãƒ³...");
    sleep(Duration::from_millis(500)).await;
    println!("âœ“ ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰æº–å‚™å®Œäº†");
}

/// çŠ¶æ³ã‚’ç·åˆçš„ã«åˆ¤æ–­ã—ã¦æœ€é©ãªæˆ¦è¡“ã‚’æ±ºå®š
///
/// ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹ãƒ©ã‚¤ãƒ³ã€ãƒãƒ¼ãƒ ãƒ¡ã‚¤ãƒˆã®çŠ¶æ…‹ã€ãƒœãƒ¼ãƒ«ã®çŠ¶æ³ã‚’ç·åˆçš„ã«åˆ¤æ–­ã—ã€
/// æœ€é©ãªæ”»æ’ƒãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é¸æŠã—ã¾ã™ã€‚
///
/// # Arguments
///
/// * `_ball` - å—ã‘å–ã£ãŸãƒœãƒ¼ãƒ«ï¼ˆå°†æ¥çš„ãªæ‹¡å¼µç”¨ã«äºˆç´„ï¼‰
/// * `defense` - ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹ãƒ©ã‚¤ãƒ³ã®çŠ¶æ…‹
/// * `teammates` - ãƒãƒ¼ãƒ ãƒ¡ã‚¤ãƒˆã®æº–å‚™çŠ¶æ…‹
///
/// # Returns
///
/// æœ€é©ãªæ”»æ’ƒåˆ¤æ–­ã®æ–‡å­—åˆ—
///
/// # Decision Logic
///
/// 1. å·¦ã«ã‚®ãƒ£ãƒƒãƒ—ãŒã‚ã‚Šã€ãƒãƒƒã‚¯ã‚¹ãŒæº–å‚™å®Œäº† â†’ å·¦ã‚µã‚¤ãƒ‰ã¸ãƒ‘ã‚¹å±•é–‹
/// 2. ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ãŒãªãã€ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ãŒæº–å‚™å®Œäº† â†’ ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ«
/// 3. ãã‚Œä»¥å¤– â†’ ãƒã‚¤ãƒ‘ãƒ³ãƒˆã‚­ãƒƒã‚¯
async fn make_decision(_ball: String, defense: DefenseLine, teammates: Teammates) -> String {
    println!("\nğŸ§  çŠ¶æ³ã‚’çµ±åˆã—ã¦åˆ¤æ–­...");

    if defense.gap_on_left && teammates.backs_ready {
        "å·¦ã‚µã‚¤ãƒ‰ã¸ãƒ‘ã‚¹å±•é–‹".to_string()
    } else if !defense.pressure && teammates.forwards_ready {
        "ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã«ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ«".to_string()
    } else {
        "ãƒã‚¤ãƒ‘ãƒ³ãƒˆã‚­ãƒƒã‚¯".to_string()
    }
}

#[tokio::main]
async fn main() {
    let start = std::time::Instant::now();

    println!("=== æ”»æ’ƒé–‹å§‹ ===\n");

    // ãƒ•ã‚§ãƒ¼ã‚º1: æƒ…å ±åé›†ï¼ˆã™ã¹ã¦ä¸¦è¡Œå®Ÿè¡Œï¼‰
    let (ball, defense, teammates) =
        tokio::join!(wait_for_ball(), read_defense(), check_teammates());

    // ãƒ•ã‚§ãƒ¼ã‚º2: ã‚µã‚¤ãƒ³å‡ºã—ï¼ˆä¸¦è¡Œå®Ÿè¡Œï¼‰
    tokio::join!(signal_backs(), signal_forwards());

    // ãƒ•ã‚§ãƒ¼ã‚º3: åˆ¤æ–­ã¨å®Ÿè¡Œ
    let decision = make_decision(ball, defense, teammates).await;

    let duration = start.elapsed();

    println!("\nğŸ¯ æ±ºå®š: {}", decision);
    println!("â±ï¸  åˆ¤æ–­ã¾ã§ã®æ™‚é–“: {:.1}ç§’", duration.as_secs_f64());
    println!(
        "\nğŸ’¡ ä¸¦è¡Œå‡¦ç†ã«ã‚ˆã‚Šã€é †æ¬¡å‡¦ç†ã®13ç§’ã‹ã‚‰{:.1}ç§’ã«çŸ­ç¸®ï¼",
        duration.as_secs_f64()
    );
}
